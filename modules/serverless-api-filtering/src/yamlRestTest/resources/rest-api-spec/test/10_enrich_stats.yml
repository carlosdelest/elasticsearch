setup:
  - do:
      indices.create:
        index: bar
        body:
          mappings:
            properties:
              baz:
                type: keyword
              a:
                type: keyword
              b:
                type: keyword

  - do:
      enrich.put_policy:
        name: policy-crud
        body:
          match:
            indices: [ "bar*" ]
            match_field: baz
            enrich_fields: [ "a", "b" ]

  - do:
      enrich.execute_policy:
        name: policy-crud

---
teardown:
  - do:
      enrich.delete_policy:
        name: policy-crud

---
"Enrich stats non operator with rollup":
  - do:
      enrich.stats: {}
  - length: { executing_policies: 0}
  - length: { coordinator_stats: 1}
  - match: { coordinator_stats.0.node_id: "serverless" }
  - match: { coordinator_stats.0.queue_size: 0}
  - match: { coordinator_stats.0.remote_requests_current: 0}
  - gte: { coordinator_stats.0.remote_requests_total: 0}
  - gte: { coordinator_stats.0.executed_searches_total: 0}
  - length: { cache_stats: 1}
  - match: { cache_stats.0.node_id: "serverless"}

---
"Enrich stats operator no rollup":
  - skip:
      features: headers

  - do:
      headers: { Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" } # x_pack_rest_user, an operator
      enrich.stats: {}
  - length: { executing_policies: 0}
  - length: { coordinator_stats: 1}
  - match: { coordinator_stats.0.node_id: '/^((?!serverless).)*$/'}
  - match: { coordinator_stats.0.queue_size: 0}
  - match: { coordinator_stats.0.remote_requests_current: 0}
  - gte: { coordinator_stats.0.remote_requests_total: 0}
  - gte: { coordinator_stats.0.executed_searches_total: 0}
  - length: { cache_stats: 1}
  - match: { cache_stats.0.node_id: '/^((?!serverless).)*$/'}

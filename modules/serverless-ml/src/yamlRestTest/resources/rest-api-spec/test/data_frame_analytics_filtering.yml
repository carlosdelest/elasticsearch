setup:
  - skip:
      features: headers
  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      indices.create:
        index: source-index
        body:
          mappings:
            properties:
              numeric_field: { type: "long" }
              keyword_field: { type: "keyword" }

  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      index:
        index: source-index
        body: { numeric_field: 1.0, keyword_field: "class_a" }

  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      index:
        index: source-index
        body: { numeric_field: 2.0, keyword_field: "class_b" }

  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      indices.refresh:
        index: source-index

---
"Test data frame analytics responses as operator with no filtering":
  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # x_pack_rest_user, an operator
      ml.put_data_frame_analytics:
        id: "operator-classification"
        body: >
          {
            "source": {
              "index": "source-index"
            },
            "dest": {
              "index": "dest-index"
            },
            "analysis": { "classification": { "dependent_variable": "keyword_field" } }
          }

  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # x_pack_rest_user, an operator
      ml.start_data_frame_analytics:
        id: "operator-classification"
  # We don't know what the node ID will be, but it will be 22 characters and "serverless" is shorter
  - length: { node: 22 }

  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # x_pack_rest_user, an operator
      ml.get_data_frame_analytics_stats:
        id: "operator-classification"
  - match: { data_frame_analytics.0.id: "operator-classification" }
  # We don't know what the node ID will be, but it will be 22 characters and "serverless" is shorter
  - length: { data_frame_analytics.0.node.id: 22 }
---
"Test data frame analytics responses as non operator with filtering":
  - do:
      ml.put_data_frame_analytics:
        id: "non-operator-classification"
        body: >
          {
            "source": {
              "index": "source-index"
            },
            "dest": {
              "index": "dest-index"
            },
            "analysis": { "classification": { "dependent_variable": "keyword_field" } }
          }

  - do:
      ml.start_data_frame_analytics:
        id: "non-operator-classification"
  - match: { node: serverless }

  - do:
      ml.get_data_frame_analytics_stats:
        id: "non-operator-classification"
  - match: { data_frame_analytics.0.id: "non-operator-classification" }
  - match: { data_frame_analytics.0.node.id: serverless }
